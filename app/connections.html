// Connection form submission
document.getElementById('connection-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!validateConnectionName(document.getElementById('name'))) {
        return false;
    }

    const form = this;
    const createLoading = document.getElementById('create-loading');
    const createError = document.getElementById('create-error');

    // Hide any previous error
    createError.classList.add('hidden');
    createError.textContent = '';

    // Show loading
    form.style.display = 'none';
    createLoading.classList.remove('hidden');

    // Ensure the checkbox value is properly set
    const persistentHomeCheckbox = document.getElementById('persistent_home');
    let formData = new FormData(form);

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to create connection');
            }

            // Success - show notification
            const notificationContainer = document.createElement('div');
            notificationContainer.className = 'notification-container';
            notificationContainer.innerHTML = `
                <div class="notification success">
                    ${data.message || 'Connection created successfully'}
                </div>
            `;
            document.body.appendChild(notificationContainer);

            // Remove notification after delay
            setTimeout(() => {
                notificationContainer.querySelector('.notification').style.opacity = '0';
                setTimeout(() => notificationContainer.remove(), 300);
            }, 3000);

            // Reload the page after a short delay to show the new connection
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            // Handle non-JSON response (redirect)
            window.location.reload();
        }
    } catch (error) {
        // Show error
        createLoading.classList.add('hidden');
        form.style.display = 'block';
        createError.textContent = error.message;
        createError.classList.remove('hidden');
    }
});
