{% extends "base.html" %}

{% block title %}Add User - Desktop Manager{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Add New User</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            <p>{{ message }}</p>
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="requirements-box">
        <h4>Requirements:</h4>
        <ul>
            <li>Username must be at least 3 characters long</li>
            <li>OIDC Subject Identifier (sub) is required</li>
            <li>Other user information will be filled from OIDC during first login</li>
        </ul>
    </div>

    <form method="post" action="{{ url_for('users.add_user') }}" id="user-form">
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required minlength="3">
            <small class="error-message" id="username-error"><!-- Error message will appear here --></small>
        </div>

        <div class="form-group">
            <label for="sub">OIDC Subject Identifier (sub):</label>
            <input type="text" id="sub" name="sub" required>
            <small class="form-help">This is the unique identifier from the OIDC provider.</small>
            <small class="error-message" id="sub-error"><!-- Error message will appear here --></small>
        </div>

        <div class="form-group">
            <div class="checkbox-wrapper">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_admin" value="true">
                    Admin User
                </label>
            </div>
            <small class="form-help">Administrators can manage users and desktop configurations.</small>
        </div>

        <div id="loading" class="hidden">
            <div class="loading-wave">
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="button" id="submit-btn">Add User</button>
            <a href="{{ url_for('users.view_users') }}" class="button secondary">Cancel</a>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('user-form').addEventListener('submit', function(e) {
    const username = document.getElementById('username').value;
    const sub = document.getElementById('sub').value;

    // Clear previous error messages
    document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
        el.textContent = '';
    });

    let hasError = false;

    // Username validation
    if (username.length < 3) {
        e.preventDefault();
        const usernameError = document.getElementById('username-error');
        usernameError.textContent = 'Username must be at least 3 characters long';
        usernameError.style.display = 'block';
        hasError = true;
    }

    // Sub validation
    if (!sub) {
        e.preventDefault();
        const subError = document.getElementById('sub-error');
        subError.textContent = 'OIDC Subject Identifier is required';
        subError.style.display = 'block';
        hasError = true;
    }

    if (!hasError) {
        document.getElementById('loading').classList.add('visible');
        document.getElementById('submit-btn').classList.add('hidden');
    }
});
</script>
{% endblock %}
