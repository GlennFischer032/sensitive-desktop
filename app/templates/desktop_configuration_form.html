{% extends "base.html" %}

{% block title %}
  {% if configuration %}Edit{% else %}Add{% endif %} Desktop Configuration - Desktop Manager
{% endblock %}

{% block content %}
<div class="form-container">
  <h2>{% if configuration %}Edit{% else %}Create{% endif %} Desktop Configuration</h2>

  <form id="configForm" method="post" class="configuration-form">
    <div class="form-group">
      <label for="name">Name *</label>
      <input type="text" id="name" name="name" value="{{ configuration.name if configuration else '' }}" required>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" rows="3">{{ configuration.description if configuration else '' }}</textarea>
    </div>

    <div class="form-group">
      <label for="image">Docker Image *</label>
      <input type="text" id="image" name="image" value="{{ configuration.image if configuration else '' }}" required>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="min_cpu">Minimum CPU Cores *</label>
        <input type="number" id="min_cpu" name="min_cpu" min="1" max="32" value="{{ configuration.min_cpu if configuration else 1 }}" required>
      </div>

      <div class="form-group">
        <label for="max_cpu">Maximum CPU Cores *</label>
        <input type="number" id="max_cpu" name="max_cpu" min="1" max="32" value="{{ configuration.max_cpu if configuration else 4 }}" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="min_ram">Minimum RAM *</label>
        <select id="min_ram" name="min_ram" required>
          <option value="1024Mi" {% if configuration and configuration.min_ram == '1024Mi' %}selected{% endif %}>1GB</option>
          <option value="2048Mi" {% if configuration and configuration.min_ram == '2048Mi' %}selected{% endif %}>2GB</option>
          <option value="4096Mi" {% if configuration and configuration.min_ram == '4096Mi' or not configuration %}selected{% endif %}>4GB</option>
          <option value="8192Mi" {% if configuration and configuration.min_ram == '8192Mi' %}selected{% endif %}>8GB</option>
          <option value="16384Mi" {% if configuration and configuration.min_ram == '16384Mi' %}selected{% endif %}>16GB</option>
          <option value="32768Mi" {% if configuration and configuration.min_ram == '32768Mi' %}selected{% endif %}>32GB</option>
          <option value="65536Mi" {% if configuration and configuration.min_ram == '65536Mi' %}selected{% endif %}>64GB</option>
        </select>
      </div>

      <div class="form-group">
        <label for="max_ram">Maximum RAM *</label>
        <select id="max_ram" name="max_ram" required>
          <option value="1024Mi" {% if configuration and configuration.max_ram == '1024Mi' %}selected{% endif %}>1GB</option>
          <option value="2048Mi" {% if configuration and configuration.max_ram == '2048Mi' %}selected{% endif %}>2GB</option>
          <option value="4096Mi" {% if configuration and configuration.max_ram == '4096Mi' %}selected{% endif %}>4GB</option>
          <option value="8192Mi" {% if configuration and configuration.max_ram == '8192Mi' %}selected{% endif %}>8GB</option>
          <option value="16384Mi" {% if configuration and configuration.max_ram == '16384Mi' or not configuration %}selected{% endif %}>16GB</option>
          <option value="32768Mi" {% if configuration and configuration.max_ram == '32768Mi' %}selected{% endif %}>32GB</option>
          <option value="65536Mi" {% if configuration and configuration.max_ram == '65536Mi' %}selected{% endif %}>64GB</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" name="is_public" id="is_public" {% if configuration and configuration.is_public == false %}{% else %}checked{% endif %}>
        Make this configuration public
      </label>
    </div>

    <div class="form-group" id="user-access-group" style="display: {% if configuration and configuration.is_public == false %}block{% else %}none{% endif %};">
      <label>User Access</label>
      <div class="user-list">
        {% if users %}
          {% for user in users %}
            {% if not user.is_admin %}
            <label class="checkbox-label">
              <input type="checkbox" name="allowed_users" value="{{ user.username }}"
                    {% if configuration and configuration.allowed_users and user.username in configuration.allowed_users %}checked{% endif %}>
              {{ user.username }}
            </label>
            {% endif %}
          {% endfor %}
        {% else %}
          <p>No users available</p>
        {% endif %}
      </div>
    </div>

    <div class="form-actions">
      <button type="button" id="submitBtn" class="button">
        {% if configuration %}Save Changes{% else %}Create Configuration{% endif %}
      </button>
      <a href="{{ url_for('desktop_configurations.list_configurations') }}" class="button secondary">Cancel</a>
    </div>
  </form>
</div>

<style>
  .form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-row {
    display: flex;
    gap: 20px;
  }

  .form-row .form-group {
    flex: 1;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }

  input[type="text"],
  input[type="number"],
  textarea,
  select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    font-weight: normal;
    margin-bottom: 8px;
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    vertical-align: middle;
  }

  .user-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
  }

  .user-list .checkbox-label {
    margin-bottom: 10px;
    padding: 4px 0;
  }

  .user-list .checkbox-label:hover {
    background-color: #f8f9fa;
  }

  .form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
  }

  .button {
    padding: 8px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }

  .button.secondary {
    background-color: #6c757d;
  }
</style>

<script>
// Initialize the user access group visibility when the page loads
document.addEventListener('DOMContentLoaded', function() {
    const isPublic = document.getElementById('is_public');
    const userAccessGroup = document.getElementById('user-access-group');
    userAccessGroup.style.display = isPublic.checked ? 'none' : 'block';
});

document.getElementById('is_public').addEventListener('change', function() {
    const userAccessGroup = document.getElementById('user-access-group');
    userAccessGroup.style.display = this.checked ? 'none' : 'block';
});

// Add submit handler using fetch API with proper JSON content-type
document.getElementById('submitBtn').addEventListener('click', function(e) {
    e.preventDefault();

    const form = document.getElementById('configForm');
    const formData = new FormData(form);
    const isPublicCheckbox = document.getElementById('is_public');

    // Convert FormData to JSON object
    const jsonData = {};
    formData.forEach((value, key) => {
        // Handle allowed_users as array
        if (key === 'allowed_users') {
            if (!jsonData[key]) {
                jsonData[key] = [];
            }
            jsonData[key].push(value);
        }
        // Handle numeric values
        else if (key === 'min_cpu' || key === 'max_cpu') {
            jsonData[key] = parseInt(value, 10);
        }
        // All other fields
        else {
            jsonData[key] = value;
        }
    });

    // Set is_public based on checkbox state
    jsonData['is_public'] = isPublicCheckbox.checked;

    // If no allowed users and not public, set empty array
    if (!jsonData.allowed_users && !jsonData.is_public) {
        jsonData.allowed_users = [];
    }

    // POST as JSON
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.error) {
            alert('Error: ' + data.error);
        } else if (data && data.success) {
            // Redirect to configurations list on success
            window.location.href = "{{ url_for('desktop_configurations.list_configurations') }}";
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting form: ' + error.message);
    });
});
</script>

{% endblock %}
